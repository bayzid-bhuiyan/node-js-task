<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* LOGIN PAGE STYLES */
        .full-height-row { height: 100vh; }
        .login-left { 
            background-color: white; 
            padding: 50px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
        }
        .login-right { 
            background: url('./photo.png') no-repeat center center; 
            background-size: cover; 
            height: 100%; 
        }
        .app-logo { 
            font-size: 2rem; 
            font-weight: 900; 
            letter-spacing: 2px; 
            color: #0d6efd; 
            margin-bottom: 2rem; 
            text-transform: uppercase; 
        }
        
        /* TABLE STYLES (Professional & Boring) */
        .user-list-title { text-align: center; margin: 30px 0; font-weight: bold; }
        .custom-table { border: 2px solid black; width: 100%; }
        .custom-table thead th { 
            background-color: #e0e0e0; 
            border: 2px solid black; 
            padding: 10px; 
            text-align: center; 
        }
        .custom-table tbody td { 
            border: 2px solid black; 
            padding: 8px; 
            text-align: center; 
            vertical-align: middle; 
        }
        
        /* STATUS BADGES */
        .status-active { color: green; font-weight: bold; }
        .status-blocked { color: red; font-weight: bold; }
        .status-unverified { color: #d39e00; font-weight: bold; } /* Orange for unverified */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [view, setView] = useState('login');
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [users, setUsers] = useState([]);
            const [selected, setSelected] = useState([]);
            const [currentUser, setCurrentUser] = useState('');
            const [error, setError] = useState('');
            // NEW: Loading state to disable buttons during email sending
            const [loading, setLoading] = useState(false);

            // AXIOS INTERCEPTOR: Redirect if blocked
            axios.interceptors.response.use(
                response => response,
                error => {
                    if (error.response && error.response.status === 403) {
                        logout();
                        alert("Session expired or access denied (User blocked/deleted).");
                        return Promise.reject(error);
                    }
                    return Promise.reject(error);
                }
            );

            useEffect(() => {
                if (token) fetchUsers();
            }, [token]);

            const logout = () => {
                setToken(null);
                localStorage.removeItem('token');
                setView('login');
                setUsers([]);
            };

            const fetchUsers = async () => {
                try {
                    const res = await axios.get('/api/users', { headers: { 'Authorization': token } });
                    setUsers(res.data);
                    setView('home');
                } catch (err) { console.error(err); }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true); // Start Loading
                try {
                    const res = await axios.post('/api/login', {
                        email: e.target.email.value,
                        password: e.target.password.value
                    });
                    localStorage.setItem('token', res.data.token);
                    setToken(res.data.token);
                    setCurrentUser(res.data.name);
                } catch (err) {
                    setError(err.response?.data || "Login failed");
                } finally {
                    setLoading(false); // Stop Loading
                }
            };

            // UPDATED REGISTER HANDLER (With Loading State)
            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true); // START: Lock the button
                
                try {
                    // Send request to server (Wait for Email to send...)
                    const res = await axios.post('/api/register', {
                        name: e.target.name.value,
                        email: e.target.email.value,
                        password: e.target.password.value
                    });
                    
                    // SUCCESS:
                    alert(res.data.message); // "Registration successful! Please check your email."
                    setView('login');
                    
                } catch (err) {
                    // FAILED:
                    const msg = err.response?.data?.message || "Registration failed";
                    alert("FAILED: " + msg);
                    setError(msg);
                } finally {
                    setLoading(false); // STOP: Unlock the button
                }
            };

            const handleAction = async (action) => {
                if (action !== 'deleteUnverified' && selected.length === 0) return;

                try {
                    await axios.post('/api/admin/action', 
                        { userIds: selected, action },
                        { headers: { 'Authorization': token } }
                    );
                    fetchUsers();
                    setSelected([]);
                } catch (err) { alert("Action failed"); }
            };

            const toggleSelect = (id) => {
                if (selected.includes(id)) setSelected(selected.filter(x => x !== id));
                else setSelected([...selected, id]);
            };

            const toggleAll = () => {
                if (selected.length === users.length) setSelected([]);
                else setSelected(users.map(u => u.id));
            };

            // RENDER: LOGIN & REGISTER
            if (!token) {
                return (
                    <div className="container-fluid">
                        <div className="row full-height-row">
                            <div className="col-md-6 login-left">
                                <div className="app-logo">THE APP</div>
                                <h4 className="mb-2 fw-bold">{view === 'login' ? 'Sign In to The App' : 'Start your journey'}</h4>
                                <p className="text-muted mb-4">{view === 'login' ? 'Enter your details' : 'Register specific details'}</p>
                                
                                {error && <div className="alert alert-danger py-2">{error}</div>}
                                
                                <form onSubmit={view === 'login' ? handleLogin : handleRegister}>
                                    {view === 'register' && (
                                        <input name="name" className="form-control mb-3" placeholder="Full Name" required disabled={loading} />
                                    )}
                                    <input type="email" name="email" className="form-control mb-3" placeholder="E-mail" required disabled={loading} />
                                    <input type="password" name="password" className="form-control mb-3" placeholder="Password" required disabled={loading} />
                                    
                                    {view === 'login' && (
                                        <div className="form-check mb-3">
                                            <input className="form-check-input" type="checkbox" id="remember" />
                                            <label className="form-check-label" htmlFor="remember">Remember me</label>
                                        </div>
                                    )}
                                    
                                    <button className="btn btn-primary w-100 mt-2" disabled={loading}>
                                        {loading 
                                            ? (view === 'login' ? 'Signing In...' : 'Sending Verification...') 
                                            : (view === 'login' ? 'Sign In' : 'Sign Up')
                                        }
                                    </button>
                                </form>

                                <div className="mt-4">
                                    <span className="text-muted">
                                        {view === 'login' ? "Don't have an account?" : "Already have an account?"}
                                        <a href="#" className="ms-2 text-decoration-none" onClick={() => !loading && setView(view === 'login' ? 'register' : 'login')}>
                                            {view === 'login' ? 'Sign Up' : 'Sign In'}
                                        </a>
                                    </span>
                                </div>
                            </div>
                            <div className="col-md-6 p-0 d-none d-md-block">
                                <div className="login-right"></div>
                            </div>
                        </div>
                    </div>
                );
            }

            // RENDER: USER LIST
            return (
                <div className="container mt-4">
                    <h1 className="user-list-title">User List</h1>
                    
                    {/* TOOLBAR WITH 4 REQUIRED BUTTONS */}
                    <div className="d-flex justify-content-between align-items-end mb-2">
                        <div className="d-flex gap-2">
                            <button className="btn btn-danger" title="Block Selected" onClick={() => handleAction('block')}>
                                Block
                            </button>
                            <button className="btn btn-secondary" title="Unblock Selected" onClick={() => handleAction('unblock')}>
                                <i className="bi bi-unlock-fill"></i>
                            </button>
                            <button className="btn btn-dark" title="Delete Selected" onClick={() => handleAction('delete')}>
                                <i className="bi bi-trash-fill"></i>
                            </button>
                            {/* NEW: DELETE UNVERIFIED ICON */}
                            <button className="btn btn-warning" title="Delete Unverified Users" onClick={() => handleAction('deleteUnverified')}>
                                <i className="bi bi-person-x-fill"></i>
                            </button>
                        </div>
                        
                        <div>
                            <span className="me-3 fw-bold">Hello, {currentUser}</span>
                            <button onClick={logout} className="btn btn-outline-dark btn-sm" title="Logout">Logout</button>
                        </div>
                    </div>

                    <table className="custom-table">
                        <thead>
                            <tr>
                                <th style={{width: '50px'}}>
                                    <input type="checkbox" className="form-check-input" 
                                        onChange={toggleAll} 
                                        checked={users.length > 0 && selected.length === users.length} 
                                    />
                                </th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Last Login</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {users.map(user => (
                                <tr key={user.id} className={user.status === 'blocked' ? 'table-danger' : ''}>
                                    <td>
                                        <input type="checkbox" className="form-check-input" 
                                            checked={selected.includes(user.id)} 
                                            onChange={() => toggleSelect(user.id)} 
                                        />
                                    </td>
                                    <td className="fw-bold">{user.name}</td>
                                    <td>{user.email}</td>
                                    <td>{user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                                    <td className={
                                        user.status === 'active' ? 'status-active' : 
                                        user.status === 'blocked' ? 'status-blocked' : 'status-unverified'
                                    }>
                                        {user.status}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>